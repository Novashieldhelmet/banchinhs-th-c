<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EzTest Pro - Mobile Optimized</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#6366f1', // Indigo-500
                        primaryHover: '#4f46e5',
                        secondary: '#10b981', // Emerald-500
                        bgLight: '#f8fafc',
                        card: '#ffffff'
                    },
                    fontFamily: { sans: ['Inter', 'Segoe UI', 'sans-serif'] },
                    animation: {
                        'fade-in': 'fadeIn 0.5s ease-out forwards',
                        'slide-up': 'slideUp 0.4s ease-out forwards',
                        'pop': 'pop 0.2s ease-in-out',
                        'shake': 'shake 0.4s cubic-bezier(.36,.07,.19,.97) both',
                        'slide-in-right': 'slideInRight 0.3s ease-out forwards'
                    },
                    keyframes: {
                        fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
                        slideUp: { '0%': { transform: 'translateY(20px)', opacity: '0' }, '100%': { transform: 'translateY(0)', opacity: '1' } },
                        pop: { '0%': { transform: 'scale(0.95)' }, '100%': { transform: 'scale(1)' } },
                        shake: { '10%, 90%': { transform: 'translate3d(-1px, 0, 0)' }, '20%, 80%': { transform: 'translate3d(2px, 0, 0)' }, '30%, 50%, 70%': { transform: 'translate3d(-4px, 0, 0)' }, '40%, 60%': { transform: 'translate3d(4px, 0, 0)' } },
                        slideInRight: { '0%': { transform: 'translateX(100%)' }, '100%': { transform: 'translateX(0)' } }
                    }
                }
            }
        }
    </script>

    <style>
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* View transitions */
        .view-section { display: none; }
        .active-view { display: block; animation: fadeIn 0.4s ease-out; }
        
        /* Glassmorphism */
        .glass { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(12px); border-bottom: 1px solid rgba(226, 232, 240, 0.8); }
        .modal-overlay { background-color: rgba(15, 23, 42, 0.4); backdrop-filter: blur(4px); }
        
        /* Inputs */
        .input-field { transition: all 0.2s; }
        .input-field:focus { box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1); border-color: #6366f1; }

        /* Practice Mode */
        .opt-correct { background-color: #ecfdf5 !important; border-color: #10b981 !important; color: #047857 !important; font-weight: 600; box-shadow: 0 0 0 1px #10b981; }
        .opt-wrong { background-color: #fef2f2 !important; border-color: #ef4444 !important; color: #b91c1c !important; opacity: 0.7; }
        .shake-element { animation: shake 0.4s cubic-bezier(.36,.07,.19,.97) both; }

        /* Rank Badge */
        .rank-1 { background: linear-gradient(135deg, #facc15 0%, #eab308 100%); color: white; box-shadow: 0 4px 6px -1px rgba(234, 179, 8, 0.4); }
        .rank-2 { background: linear-gradient(135deg, #94a3b8 0%, #64748b 100%); color: white; box-shadow: 0 4px 6px -1px rgba(100, 116, 139, 0.4); }
        .rank-3 { background: linear-gradient(135deg, #fb923c 0%, #ea580c 100%); color: white; box-shadow: 0 4px 6px -1px rgba(234, 88, 12, 0.4); }

        .text-content { white-space: pre-wrap; word-break: break-word; line-height: 1.6; }

        /* Drawer for Exam Palette */
        .drawer-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.3); z-index: 49; opacity: 0; visibility: hidden; transition: all 0.3s; backdrop-filter: blur(2px); }
        .drawer-overlay.open { opacity: 1; visibility: visible; }
        .drawer { position: fixed; top: 0; right: 0; bottom: 0; width: 300px; max-width: 85vw; background: white; z-index: 50; transform: translateX(100%); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); box-shadow: -4px 0 25px rgba(0,0,0,0.1); }
        .drawer.open { transform: translateX(0); }
    </style>
</head>
<body class="bg-bgLight text-slate-800 min-h-screen font-sans pb-24 selection:bg-primary/20 selection:text-primary">

    <header class="glass sticky top-0 z-40 shadow-sm">
        <div class="max-w-7xl mx-auto px-4 h-16 flex items-center justify-between">
            <div class="flex items-center gap-3 cursor-pointer group" onclick="navigateTo('dashboard')">
                <div class="w-10 h-10 bg-gradient-to-br from-primary to-indigo-600 text-white rounded-xl flex items-center justify-center shadow-lg shadow-primary/30 group-hover:scale-105 transition-transform duration-300">
                    <i data-lucide="layers" width="24"></i>
                </div>
                <div class="hidden sm:block">
                    <h1 class="text-xl font-black tracking-tight text-slate-800 leading-none">EzTest</h1>
                    <span class="text-xs font-bold text-primary tracking-widest uppercase">Pro Platform</span>
                </div>
            </div>
            
            <div id="user-info" class="hidden flex items-center gap-3 sm:gap-6">
                <button onclick="loadStudentHistory()" class="hidden sm:flex items-center gap-2 text-sm font-bold text-slate-600 hover:text-primary bg-white hover:bg-indigo-50 border border-slate-200 hover:border-primary/30 px-4 py-2 rounded-xl transition-all shadow-sm">
                    <i data-lucide="clock" width="18"></i> Lịch sử
                </button>
                
                <div class="flex items-center gap-3 border-l border-slate-200 pl-4">
                    <div class="text-right hidden sm:block">
                        <div id="user-email" class="text-sm font-bold text-slate-800 truncate max-w-[150px]"></div>
                        <div id="user-role-badge" class="text-[10px] font-black uppercase tracking-wider px-2 py-0.5 rounded-full bg-slate-100 text-slate-500 inline-block mt-0.5"></div>
                    </div>
                    <button onclick="handleLogout()" class="w-10 h-10 rounded-xl bg-red-50 text-red-500 hover:bg-red-100 hover:text-red-600 flex items-center justify-center transition-colors" title="Đăng xuất">
                        <i data-lucide="log-out" width="20"></i>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <div id="global-loader" class="fixed inset-0 bg-white/90 backdrop-blur-sm z-50 flex flex-col items-center justify-center transition-opacity duration-300 hidden">
        <div class="relative">
            <div class="w-20 h-20 border-4 border-primary/20 border-t-primary rounded-full animate-spin"></div>
            <div class="absolute top-0 left-0 w-20 h-20 border-4 border-transparent border-b-secondary/50 rounded-full animate-spin" style="animation-duration: 2s;"></div>
            <div class="absolute inset-0 flex items-center justify-center">
                <i data-lucide="zap" class="text-primary animate-pulse" width="24"></i>
            </div>
        </div>
        <p class="mt-6 text-sm font-bold text-slate-500 tracking-widest uppercase animate-pulse">Đang xử lý...</p>
    </div>

    <main class="max-w-7xl mx-auto px-4 py-8" id="app-container">
        
        <div id="view-login" class="view-section active-view">
            <div class="max-w-md mx-auto bg-white p-8 sm:p-10 rounded-3xl shadow-2xl shadow-indigo-100 border border-white relative overflow-hidden animate-slide-up">
                <div class="absolute top-0 left-0 w-full h-1.5 bg-gradient-to-r from-primary via-purple-500 to-secondary"></div>
                <div class="text-center mb-10">
                    <div class="w-16 h-16 bg-indigo-50 rounded-2xl flex items-center justify-center mx-auto mb-4 text-primary">
                        <i data-lucide="log-in" width="32"></i>
                    </div>
                    <h2 class="text-3xl font-black text-slate-800 mb-2">Chào mừng trở lại!</h2>
                    <p class="text-slate-400 font-medium text-sm">Đăng nhập để tiếp tục hành trình tri thức.</p>
                </div>
                <div class="space-y-6">
                    <div class="group">
                        <label class="block text-xs font-bold text-slate-400 uppercase mb-2 pl-1">Email</label>
                        <div class="relative">
                            <i data-lucide="mail" class="absolute left-4 top-3.5 text-slate-400 w-5 h-5 group-focus-within:text-primary transition-colors"></i>
                            <input type="email" id="login-email" class="input-field w-full pl-12 pr-4 py-3.5 border border-slate-200 rounded-xl bg-slate-50/50 outline-none font-semibold text-slate-700 placeholder-slate-400" placeholder="name@example.com">
                        </div>
                    </div>
                    <div class="group">
                        <label class="block text-xs font-bold text-slate-400 uppercase mb-2 pl-1">Mật khẩu</label>
                        <div class="relative">
                            <i data-lucide="lock" class="absolute left-4 top-3.5 text-slate-400 w-5 h-5 group-focus-within:text-primary transition-colors"></i>
                            <input type="password" id="login-pass" class="input-field w-full pl-12 pr-4 py-3.5 border border-slate-200 rounded-xl bg-slate-50/50 outline-none font-semibold text-slate-700 placeholder-slate-400" placeholder="••••••••">
                        </div>
                    </div>
                    <button onclick="handleLogin()" class="w-full py-4 bg-gradient-to-r from-primary to-indigo-600 text-white font-bold rounded-xl shadow-lg shadow-indigo-200 hover:shadow-indigo-400 hover:-translate-y-1 transition-all duration-300 text-lg">Đăng Nhập</button>
                    <div class="text-center pt-2">
                        <button onclick="navigateTo('register')" class="text-sm text-slate-500 hover:text-primary font-bold transition">Chưa có tài khoản? <span class="underline decoration-2 decoration-primary/30">Đăng ký ngay</span></button>
                    </div>
                </div>
            </div>
        </div>

        <div id="view-register" class="view-section">
            <div class="max-w-md mx-auto bg-white p-8 sm:p-10 rounded-3xl shadow-2xl border border-white mt-10 relative overflow-hidden animate-slide-up">
                <div class="absolute top-0 left-0 w-full h-1.5 bg-gradient-to-r from-secondary via-teal-500 to-cyan-500"></div>
                <h2 class="text-2xl font-black text-center mb-8 text-slate-800">Tạo tài khoản mới</h2>
                <div class="space-y-5">
                    <input type="email" id="reg-email" class="input-field w-full p-3.5 border border-slate-200 rounded-xl outline-none bg-slate-50/50 font-medium" placeholder="Email của bạn">
                    <input type="password" id="reg-pass" class="input-field w-full p-3.5 border border-slate-200 rounded-xl outline-none bg-slate-50/50 font-medium" placeholder="Mật khẩu (Min 6 ký tự)">
                    <button onclick="handleRegister()" class="w-full py-4 bg-gradient-to-r from-secondary to-teal-600 text-white font-bold rounded-xl shadow-lg hover:-translate-y-1 transition-all">Đăng Ký & Bắt Đầu</button>
                    <div class="text-center pt-2"><button onclick="navigateTo('login')" class="text-sm text-slate-500 hover:text-primary font-bold">Quay lại đăng nhập</button></div>
                </div>
            </div>
        </div>

        <div id="view-dashboard" class="view-section">
            <div id="admin-toolbar" class="hidden mb-8 bg-white p-6 rounded-3xl shadow-xl shadow-slate-200/40 border border-white flex flex-col md:flex-row justify-between items-center gap-6 animate-fade-in">
                <div class="flex items-center gap-4 w-full md:w-auto">
                    <div class="p-3.5 bg-gradient-to-br from-slate-800 to-slate-900 rounded-2xl text-white shadow-lg"><i data-lucide="layout-dashboard" width="24"></i></div>
                    <div><h3 class="font-black text-slate-800 text-xl">Bảng điều khiển</h3><p class="text-sm text-slate-500 font-medium">Khu vực dành riêng cho Quản trị viên</p></div>
                </div>
                <div class="flex gap-3 w-full md:w-auto">
                    <button onclick="loadUsersForAdmin()" class="flex-1 md:flex-none px-6 py-3 bg-white border-2 border-slate-100 text-slate-600 hover:border-primary hover:text-primary rounded-xl text-sm font-bold transition-all flex items-center justify-center gap-2"><i data-lucide="users" width="18"></i> Thành viên</button>
                    <button onclick="initCreateExam()" class="flex-1 md:flex-none px-6 py-3 bg-primary hover:bg-indigo-600 text-white rounded-xl text-sm font-bold shadow-lg shadow-indigo-200 hover:shadow-indigo-300 hover:-translate-y-0.5 transition-all flex items-center justify-center gap-2"><i data-lucide="plus" width="18"></i> Tạo đề thi</button>
                </div>
            </div>

            <div class="flex justify-between items-end mb-6 pb-2 px-1">
                <div>
                    <h2 class="text-3xl font-black text-slate-800 tracking-tight">Thư viện đề thi</h2>
                    <p class="text-sm text-slate-500 font-medium mt-1">Chọn thử thách và bắt đầu làm bài</p>
                </div>
                <button onclick="loadExamsFromFirestore()" class="p-2.5 text-slate-400 hover:text-primary hover:bg-white rounded-xl transition-all active:scale-95"><i data-lucide="rotate-cw" width="20"></i></button>
            </div>

            <div id="exam-list" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 animate-slide-up"></div>
            
            <div id="empty-state" class="hidden py-24 text-center">
                <div class="w-24 h-24 bg-slate-100 rounded-full flex items-center justify-center mx-auto mb-6 text-slate-300"><i data-lucide="box" width="48"></i></div>
                <p class="text-lg text-slate-500 font-bold">Chưa có đề thi nào được tạo.</p>
                <p class="text-sm text-slate-400">Hãy chờ Admin cập nhật thêm nhé!</p>
            </div>
        </div>

        <div id="view-leaderboard" class="view-section">
            <div class="max-w-5xl mx-auto">
                <div class="flex items-center gap-4 mb-8">
                    <button onclick="navigateTo('dashboard')" class="w-12 h-12 rounded-2xl bg-white border border-slate-200 flex items-center justify-center text-slate-400 hover:text-slate-800 hover:border-slate-300 transition shadow-sm"><i data-lucide="arrow-left"></i></button>
                    <div>
                        <h2 class="text-3xl font-black text-slate-800 flex items-center gap-3">Bảng Xếp Hạng <i data-lucide="trophy" class="text-yellow-500 fill-yellow-500" width="28"></i></h2>
                        <p id="lb-exam-title" class="text-base text-slate-500 font-medium mt-1">Đang tải dữ liệu...</p>
                    </div>
                </div>
                <div class="bg-white rounded-3xl shadow-xl shadow-slate-200/60 border border-slate-100 overflow-hidden animate-fade-in">
                    <div class="overflow-x-auto">
                        <table class="w-full text-left">
                            <thead class="bg-slate-50/80 backdrop-blur text-slate-500 text-xs font-extrabold uppercase tracking-wider border-b border-slate-100">
                                <tr>
                                    <th class="p-6 text-center w-24">Hạng</th>
                                    <th class="p-6">Học sinh</th>
                                    <th class="p-6 text-center">Điểm cao nhất</th>
                                    <th class="p-6 text-right">Thời gian</th>
                                </tr>
                            </thead>
                            <tbody id="leaderboard-body" class="text-sm font-semibold text-slate-700 divide-y divide-slate-50"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div id="view-take" class="view-section">
            <div class="max-w-5xl mx-auto relative">
                <div class="flex items-center justify-between mb-4 px-2">
                    <div class="flex items-center gap-3">
                         <span id="practice-badge" class="hidden text-[10px] font-black bg-amber-100 text-amber-700 px-3 py-1.5 rounded-lg uppercase tracking-wider border border-amber-200 shadow-sm">Luyện tập</span>
                         <div id="timer-display" class="font-mono text-xl font-black text-slate-700 bg-white px-3 py-1.5 rounded-xl border border-slate-200 shadow-sm">00:00</div>
                    </div>
                    <button onclick="toggleDrawer(true)" class="p-3 bg-white border border-slate-200 rounded-xl text-slate-600 hover:text-primary hover:border-primary shadow-sm active:scale-95 transition">
                        <i data-lucide="menu" width="24"></i>
                    </button>
                </div>

                <div class="bg-white rounded-3xl shadow-2xl shadow-slate-200/50 border border-white overflow-hidden flex flex-col min-h-[60vh] relative">
                    <div class="h-1.5 bg-slate-100 w-full"><div id="take-progress" class="h-full bg-gradient-to-r from-primary to-purple-500 w-0 transition-all duration-500 ease-out shadow-[0_0_10px_rgba(99,102,241,0.5)]"></div></div>

                    <div class="flex-1 overflow-y-auto p-6 sm:p-10 custom-scrollbar bg-slate-50/30">
                        <div class="flex items-center gap-3 mb-6">
                            <div class="bg-indigo-600 text-white font-black px-4 py-1.5 rounded-lg text-sm shadow-lg shadow-indigo-300">Câu <span id="take-q-num">1</span></div>
                        </div>
                        <div id="take-q-text" class="text-content text-lg sm:text-2xl font-bold text-slate-800 mb-10 leading-relaxed"></div>
                        <div id="take-options" class="space-y-4 max-w-3xl"></div>
                        
                        <div id="practice-feedback" class="hidden mt-8 p-6 rounded-2xl text-base font-bold border-l-4 shadow-sm animate-slide-up"></div>
                    </div>

                    <div class="p-5 border-t border-slate-100 bg-white flex justify-between items-center z-10 sticky bottom-0">
                        <button onclick="changeQuestion(-1)" class="px-5 py-3 rounded-xl bg-slate-100 hover:bg-slate-200 text-slate-600 font-bold text-sm transition flex items-center gap-2"><i data-lucide="arrow-left" width="18"></i> <span class="hidden sm:inline">Câu trước</span></button>
                        
                        <div class="flex gap-3">
                            <button id="btn-check-practice" onclick="checkPracticeAnswer()" class="hidden px-8 py-3 rounded-xl bg-purple-600 hover:bg-purple-700 text-white font-bold shadow-lg shadow-purple-200 transition transform hover:-translate-y-0.5 flex items-center gap-2"><i data-lucide="check-circle-2" width="20"></i> Kiểm tra</button>
                            <button id="btn-next-q" onclick="changeQuestion(1)" class="px-6 py-3 rounded-xl bg-primary hover:bg-indigo-700 text-white font-bold shadow-lg shadow-indigo-200 transition transform hover:-translate-y-0.5 flex items-center gap-2">Tiếp theo <i data-lucide="arrow-right" width="20"></i></button>
                        </div>
                    </div>
                </div>

                <div id="drawer-overlay" class="drawer-overlay" onclick="toggleDrawer(false)"></div>
                <div id="exam-drawer" class="drawer flex flex-col">
                    <div class="p-5 border-b border-slate-100 flex justify-between items-center bg-slate-50">
                        <h4 class="font-bold text-slate-800 uppercase tracking-wide">Danh sách câu</h4>
                        <button onclick="toggleDrawer(false)" class="p-2 hover:bg-slate-200 rounded-full transition"><i data-lucide="x" width="20"></i></button>
                    </div>
                    <div class="flex-1 overflow-y-auto p-4 custom-scrollbar">
                        <div class="flex justify-between items-center mb-4">
                            <span class="text-xs font-bold text-slate-400">Trạng thái</span>
                            <span id="palette-info" class="text-xs font-black bg-slate-100 text-slate-500 px-3 py-1 rounded-lg">0/0</span>
                        </div>
                        <div id="palette-grid" class="grid grid-cols-5 gap-3 content-start"></div>
                    </div>
                    <div class="p-5 border-t border-slate-100 bg-white shadow-[0_-5px_20px_rgba(0,0,0,0.05)]">
                        <button id="btn-submit-exam" onclick="submitExam()" class="w-full py-4 bg-gradient-to-r from-secondary to-emerald-600 hover:to-emerald-700 text-white font-bold rounded-2xl shadow-lg shadow-emerald-200 transition transform hover:-translate-y-1 mb-3 flex items-center justify-center gap-2 text-base"><i data-lucide="send" width="20"></i> NỘP BÀI</button>
                        <button onclick="if(confirm('Bạn muốn thoát bài thi?')) navigateTo('dashboard')" class="w-full py-3 text-slate-400 hover:text-slate-700 hover:bg-slate-50 font-bold text-xs uppercase tracking-wider rounded-xl transition">Thoát</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="view-student-history" class="view-section"><div class="max-w-5xl mx-auto"><div class="flex items-center gap-4 mb-8"><button onclick="navigateTo('dashboard')" class="w-10 h-10 rounded-xl bg-white border flex items-center justify-center hover:bg-slate-100 transition"><i data-lucide="arrow-left"></i></button><h2 class="text-3xl font-black text-slate-800">Lịch sử thi</h2></div><div class="bg-white rounded-3xl shadow-xl border overflow-hidden"><div class="overflow-x-auto"><table class="w-full text-left min-w-[600px]"><thead class="bg-slate-50 text-slate-500 text-xs font-extrabold uppercase tracking-wider border-b"><tr><th class="p-5">Đề thi</th><th class="p-5 text-center">Điểm số</th><th class="p-5 text-center">Chế độ</th><th class="p-5 text-right">Thời gian</th><th class="p-5 text-right">Thao tác</th></tr></thead><tbody id="student-history-body" class="text-sm font-semibold text-slate-700 divide-y divide-slate-50"></tbody></table></div></div></div></div>
        
        <div id="view-review-detail" class="view-section"><div class="max-w-5xl mx-auto"><div class="flex justify-between mb-8 items-center sticky top-20 z-30 bg-slate-50/95 backdrop-blur py-3 px-2 rounded-2xl border border-transparent"><div class="flex items-center gap-4"><button onclick="loadStudentHistory()" class="w-10 h-10 rounded-xl bg-white border shadow-sm flex items-center justify-center hover:text-primary transition"><i data-lucide="arrow-left"></i></button><h2 class="text-2xl font-black text-slate-800">Chi tiết bài làm</h2></div><div class="text-2xl font-black text-white bg-primary px-6 py-2 rounded-xl shadow-lg shadow-primary/30">Điểm: <span id="review-score"></span></div></div><div id="review-questions-container" class="space-y-6 pb-24"></div></div></div>
        
        <div id="history-modal" class="hidden fixed inset-0 z-50 modal flex items-center justify-center p-4"><div class="glass w-full max-w-4xl rounded-3xl shadow-2xl overflow-hidden flex flex-col max-h-[85vh] animate-pop"><div class="p-6 border-b bg-white/80 flex justify-between items-center"><h3 class="font-bold text-xl text-slate-800">Thống kê chi tiết</h3><button onclick="document.getElementById('history-modal').classList.add('hidden')" class="p-2 hover:bg-slate-100 rounded-full"><i data-lucide="x"></i></button></div><div class="flex-1 overflow-y-auto p-0 overflow-x-auto"><table class="w-full text-sm text-left"><thead class="bg-slate-50 text-slate-500 font-bold uppercase text-xs sticky top-0 backdrop-blur z-10"><tr><th class="p-5">Học sinh</th><th class="p-5 text-center">Số lần thi</th><th class="p-5 text-center">Điểm cao nhất</th><th class="p-5 text-right">Lần thi mới nhất</th></tr></thead><tbody id="history-table-body" class="divide-y divide-slate-50"></tbody></table></div></div></div>
        
        <div id="import-modal" class="hidden fixed inset-0 z-50 modal flex items-center justify-center p-4"><div class="bg-white w-full max-w-4xl rounded-3xl shadow-2xl flex flex-col max-h-[90vh] overflow-hidden animate-pop"><div class="p-5 border-b flex justify-between items-center bg-slate-50"><h3 class="font-bold text-lg flex items-center gap-2"><i data-lucide="file-input" width="20"></i> Nhập đề tự động</h3><button onclick="document.getElementById('import-modal').classList.add('hidden')" class="p-2 hover:bg-slate-200 rounded-full"><i data-lucide="x"></i></button></div><div class="p-6 flex-1 overflow-y-auto flex flex-col gap-4"><div class="border-2 border-dashed border-primary/30 bg-primary/5 rounded-2xl p-8 text-center cursor-pointer relative hover:bg-primary/10 transition group"><input type="file" accept=".txt,.docx" onchange="handleFileUpload(this)" class="absolute inset-0 opacity-0 cursor-pointer"/><i data-lucide="upload-cloud" class="mx-auto text-primary mb-3 transition group-hover:scale-110" width="40"></i><p class="text-base font-bold text-primary">Kéo thả hoặc Click để tải lên (.docx, .txt)</p><p class="text-xs text-slate-500 mt-1">Hỗ trợ nhận diện tự động thông minh</p></div><div class="bg-yellow-50 border border-yellow-100 p-4 rounded-xl text-xs text-yellow-800 space-y-1"><strong>Mẹo nhập nhanh:</strong><p>• Dán toàn bộ nội dung đề thi vào ô bên dưới (hỗ trợ hàng trăm câu một lúc).</p><p>• Đáp án đúng chỉ cần có dấu * hoặc in đậm (A., *B., a), *b)...).</p><p>• Hỗ trợ bảng đáp án cuối bài dạng "1-A, 2-B" hoặc "1.Đúng, 2.Sai".</p></div><textarea id="import-text" class="flex-1 p-5 border rounded-xl font-mono text-sm bg-slate-50 focus:bg-white focus:ring-2 focus:ring-primary outline-none min-h-[300px] resize-none" placeholder="Dán nội dung đề thi vào đây..."></textarea></div><div class="p-5 border-t flex justify-end bg-slate-50"><button onclick="processImport()" class="px-8 py-3 bg-primary text-white rounded-xl font-bold hover:bg-indigo-700 transition shadow-lg hover:shadow-indigo-200 flex items-center gap-2"><i data-lucide="wand-2" width="18"></i> Phân tích & Nhập</button></div></div></div>

        <div id="view-editor" class="view-section">
            <div class="max-w-7xl mx-auto">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-8 gap-4">
                    <div class="flex items-center gap-4">
                        <button onclick="navigateTo('dashboard')" class="w-12 h-12 rounded-2xl bg-white border border-slate-200 flex items-center justify-center text-slate-400 hover:text-slate-800 hover:border-slate-300 transition shadow-sm"><i data-lucide="arrow-left"></i></button>
                        <div><h2 id="editor-title" class="text-3xl font-black text-slate-800">Soạn thảo</h2><p class="text-sm text-slate-500 font-medium">Thiết kế bài kiểm tra của bạn</p></div>
                    </div>
                    <button onclick="document.getElementById('import-modal').classList.remove('hidden')" class="bg-white border-2 border-slate-200 text-slate-700 px-5 py-2.5 rounded-xl font-bold text-sm hover:border-primary hover:text-primary transition flex items-center gap-2 shadow-sm"><i data-lucide="file-up" width="18"></i> Nhập File Nhanh</button>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="lg:col-span-1 space-y-6">
                        <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200 space-y-4">
                             <h3 class="font-bold text-slate-800 text-sm uppercase tracking-wider border-b pb-2 mb-2">Cấu hình</h3>
                             <input type="hidden" id="edit-exam-id">
                             <div><label class="text-xs font-bold text-slate-400 mb-1 block">Tên đề</label><input id="input-title" class="w-full p-3 bg-slate-50 border-none rounded-xl text-sm font-bold focus:ring-2 focus:ring-primary outline-none"></div>
                             <div><label class="text-xs font-bold text-slate-400 mb-1 block">Mô tả</label><textarea id="input-desc" rows="2" class="w-full p-3 bg-slate-50 border-none rounded-xl text-sm focus:ring-2 focus:ring-primary outline-none"></textarea></div>
                             <div class="grid grid-cols-2 gap-3">
                                 <div><label class="text-xs font-bold text-slate-400 mb-1 block">Thời gian</label><input type="number" id="input-duration" value="45" class="w-full p-3 bg-slate-50 border-none rounded-xl text-center font-bold focus:ring-2 focus:ring-primary outline-none"></div>
                                 <div><label class="text-xs font-bold text-slate-400 mb-1 block">Chế độ</label><select id="input-mode" class="w-full p-3 bg-slate-50 border-none rounded-xl font-bold text-primary outline-none"><option value="standard">Thi Chuẩn</option><option value="practice">Luyện Tập</option></select></div>
                             </div>
                        </div>
                        <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200 space-y-4">
                            <h3 class="font-bold text-slate-800 text-sm uppercase tracking-wider border-b pb-2 mb-2">Phân quyền</h3>
                            <div class="flex justify-between items-center">
                                <span class="text-sm font-medium text-slate-600">Trạng thái</span>
                                <select id="input-status" class="bg-slate-100 text-sm font-bold rounded-lg py-1.5 px-3 outline-none" onchange="toggleAccessList()"><option value="open">Công khai</option><option value="restricted">Hạn chế</option><option value="closed">Đóng</option></select>
                            </div>
                            <div id="access-list-container" class="hidden pt-2 border-t"><label class="text-xs font-bold text-slate-400 mb-2 block">Chọn học sinh:</label><div id="student-checkbox-list" class="max-h-48 overflow-y-auto space-y-1 custom-scrollbar"></div></div>
                        </div>
                        <button onclick="saveExamToFirestore()" class="w-full py-4 bg-gradient-to-r from-primary to-indigo-600 text-white rounded-2xl font-bold shadow-lg hover:shadow-indigo-300 transform hover:-translate-y-1 transition-all flex justify-center items-center gap-2 text-lg"><i data-lucide="save"></i> LƯU ĐỀ THI</button>
                    </div>
                    <div class="lg:col-span-2 relative">
                        <div id="questions-container" class="space-y-6 pb-32"></div>
                        <div class="fab-container fixed bottom-8 right-6 z-40 flex flex-col gap-3 items-end">
                            <button onclick="editorAddQuestion('mc')" class="px-5 py-3 bg-white text-slate-700 rounded-full shadow-xl font-bold flex items-center gap-2 hover:scale-105 transition ring-1 ring-slate-200 hover:text-primary"><i data-lucide="plus-circle"></i> Trắc nghiệm</button>
                            <button onclick="editorAddQuestion('tf')" class="px-5 py-3 bg-white text-slate-700 rounded-full shadow-xl font-bold flex items-center gap-2 hover:scale-105 transition ring-1 ring-slate-200 hover:text-purple-600"><i data-lucide="check-square"></i> Đúng / Sai</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="view-users" class="view-section"><div class="max-w-4xl mx-auto"><div class="flex gap-4 mb-6"><button onclick="navigateTo('dashboard')" class="p-2 bg-white rounded-full shadow-sm"><i data-lucide="arrow-left"></i></button><h2 class="text-2xl font-bold">Quản lý User</h2></div><div class="bg-white rounded-2xl shadow border overflow-hidden"><table class="w-full text-left"><tbody id="user-table-body" class="divide-y divide-slate-50"></tbody></table></div></div></div>
        
        <div id="view-result" class="view-section"><div class="max-w-lg mx-auto bg-white p-10 rounded-3xl shadow-2xl text-center mt-10 border border-slate-100"><div class="w-24 h-24 bg-green-50 text-green-500 rounded-full flex items-center justify-center mx-auto mb-6"><i data-lucide="award" width="48"></i></div><h2 class="text-3xl font-black text-slate-800 mb-2">Hoàn thành!</h2><div class="bg-slate-50 rounded-2xl p-6 mb-8 border border-slate-100"><div class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-1">Điểm số</div><div class="text-6xl font-black text-slate-800" id="res-score"></div></div><div class="flex gap-3"><button onclick="loadStudentHistory()" class="flex-1 border-2 border-slate-200 py-3 rounded-xl font-bold hover:border-primary hover:text-primary transition">Xem lại</button><button onclick="navigateTo('dashboard')" class="flex-1 bg-slate-800 text-white py-3 rounded-xl font-bold hover:bg-slate-900 transition">Trang chủ</button></div></div></div>

    </main>

    <script>
        
        // 1. CONFIG
        const firebaseConfig = { apiKey: "AIzaSyAAInDcPdjPNLKxbr9mUTUJI7bH0Y5hak0", authDomain: "webluyenthi-75135.firebaseapp.com", projectId: "webluyenthi-75135", storageBucket: "webluyenthi-75135.firebasestorage.app", messagingSenderId: "839850093928", appId: "1:839850093928:web:721cd70a597e69a0fabadd", measurementId: "G-TL12623V03" };
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth(); const db = firebase.firestore(); const SUPER_ADMIN_EMAIL = "phuvinhtrannguyen@gmail.com";

        // 2. STATE
        let currentUser = null, userRole = 'user', exams = [], editorQuestions = [], allStudents = [];
        // Added 'streak' for gamification
        let takeState = { currentQ: 0, answers: {}, timeLeft: 0, timerId: null, currentExam: null, practiceLog: {}, streak: 0 };
// --- TÍNH NĂNG LƯU BÀI DỞ (AUTO-SAVE) ---
        function saveCurrentProgress() {
            if (!takeState.currentExam || !currentUser) return;
            
            // Tạo key duy nhất: eztest_uid_examId
            const key = `eztest_prog_${currentUser.uid}_${takeState.currentExam.id}`;
            
            const dataToSave = {
                answers: takeState.answers,
                currentQ: takeState.currentQ,
                timeLeft: takeState.timeLeft,
                practiceLog: takeState.practiceLog,
                streak: takeState.streak,
                timestamp: Date.now()
            };
            
            localStorage.setItem(key, JSON.stringify(dataToSave));
        }

        function clearProgress(examId) {
            if (!currentUser) return;
            const key = `eztest_prog_${currentUser.uid}_${examId}`;
            localStorage.removeItem(key);
        }
       // 3. AUTH & LOGIC
        auth.onAuthStateChanged(async (u) => {
            const l = document.getElementById('global-loader');
            try {
                if (u) {
                    currentUser = u;
                    if(u.email === SUPER_ADMIN_EMAIL) { userRole = 'admin'; await db.collection('users').doc(u.uid).set({email: u.email, role: 'admin'}, {merge:true}); } 
                    else { const d = await db.collection('users').doc(u.uid).get(); userRole = d.exists ? d.data().role : 'user'; }
                    updateUI(); await loadExams();
                    if(userRole === 'admin') { const us = await db.collection('users').where('role', '!=', 'admin').get(); allStudents = us.docs.map(d => ({id: d.id, ...d.data()})); }
                    navigateTo('dashboard');
                } else { navigateTo('login'); }
            } catch(e) { console.error(e); } finally { l.classList.add('hidden'); }
        });

        function navigateTo(id) { document.querySelectorAll('.view-section').forEach(e=>e.classList.remove('active-view')); document.getElementById('view-'+id).classList.add('active-view'); lucide.createIcons(); window.scrollTo(0,0); }
        function updateUI() {
            document.getElementById('user-info').classList.remove('hidden'); document.getElementById('user-email').innerText = currentUser.email;
            document.getElementById('user-role-badge').innerText = userRole === 'admin' ? 'ADMIN' : 'STUDENT';
            document.getElementById('admin-toolbar').className = userRole === 'admin' ? 'mb-8 bg-white p-6 rounded-3xl shadow-xl shadow-slate-200/40 border border-white flex flex-col md:flex-row justify-between items-center gap-6 animate-fade-in' : 'hidden';
        }
        function handleLogout() { auth.signOut().then(() => window.location.reload()); }
        async function handleLogin(){const e=document.getElementById('login-email').value,p=document.getElementById('login-pass').value;try{await auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);await auth.signInWithEmailAndPassword(e,p);}catch(x){alert(x.message);}}
        async function handleRegister(){const e=document.getElementById('reg-email').value,p=document.getElementById('reg-pass').value;try{await auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);const c=await auth.createUserWithEmailAndPassword(e,p);await db.collection('users').doc(c.user.uid).set({email:e,role:'user'});alert("OK");}catch(x){alert(x.message);}}

        // --- EXAMS ---
        async function loadExams() {
            const c = document.getElementById('exam-list'); c.innerHTML='';
            const s = await db.collection('exams').orderBy('createdAt', 'desc').get();
            s.forEach(doc => {
                const d = doc.data();
                let allow = userRole === 'admin';
                if(!allow) { if(d.status === 'open') allow = true; else if(d.status === 'restricted' && (d.allowedUsers || []).includes(currentUser.uid)) allow = true; }
                if(allow) {
                    const el = document.createElement('div'); el.className = "exam-card bg-white rounded-3xl overflow-hidden flex flex-col relative group cursor-pointer shadow-sm border border-slate-100 hover:shadow-xl transition-all duration-300";
                    let modeBadge = d.mode==='practice' ? '<span class="bg-amber-100 text-amber-800 text-[10px] font-black px-2 py-1 rounded-md uppercase tracking-wide">Luyện tập</span>' : '<span class="bg-blue-100 text-blue-800 text-[10px] font-black px-2 py-1 rounded-md uppercase tracking-wide">Thi chuẩn</span>';
                    let adminTool = userRole === 'admin' ? `<div class="absolute top-4 right-4 flex gap-1 opacity-0 group-hover:opacity-100 transition-all duration-300 bg-white/80 backdrop-blur rounded-xl p-1 shadow-sm border z-10"><button onclick="showAdminHistory('${doc.id}')" class="p-2 hover:bg-purple-50 text-purple-600 rounded-lg transition" title="Thống kê"><i data-lucide="bar-chart-2" width="16"></i></button><button onclick="editExam('${doc.id}')" class="p-2 hover:bg-orange-50 text-orange-600 rounded-lg transition"><i data-lucide="edit" width="16"></i></button><button onclick="deleteExam('${doc.id}')" class="p-2 hover:bg-red-50 text-red-500 rounded-lg transition"><i data-lucide="trash-2" width="16"></i></button></div>` : '';
                    el.innerHTML = `${adminTool}<div class="p-6 flex-1 flex flex-col"><div class="flex justify-between items-start mb-4"><div class="w-12 h-12 bg-gradient-to-br from-slate-100 to-slate-200 text-slate-500 rounded-2xl flex items-center justify-center group-hover:from-primary group-hover:to-indigo-600 group-hover:text-white transition-all duration-500 shadow-inner"><i data-lucide="file-text" width="24"></i></div>${modeBadge}</div><h3 class="font-bold text-xl text-slate-800 mb-2 line-clamp-1 group-hover:text-primary transition">${d.title}</h3><p class="text-slate-400 text-sm mb-4 line-clamp-2 leading-relaxed">${d.description||'Chưa có mô tả.'}</p><div class="mt-auto flex items-center gap-4 text-xs font-bold text-slate-400 border-t border-slate-50 pt-4"><span class="flex items-center gap-1"><i data-lucide="list" width="14"></i> ${d.questions?.length||0} Câu</span><span class="flex items-center gap-1"><i data-lucide="clock" width="14"></i> ${d.duration}p</span></div></div><div class="px-6 py-4 bg-slate-50/50 flex items-center justify-between border-t border-slate-100"><button onclick="startExam('${doc.id}')" class="text-sm font-black text-primary flex items-center gap-1 hover:gap-2 transition-all">VÀO THI <i data-lucide="arrow-right" width="16"></i></button><button onclick="showLeaderboard('${doc.id}', '${d.title}')" class="p-2 text-yellow-500 hover:bg-yellow-50 rounded-full transition"><i data-lucide="trophy" width="20"></i></button></div>`;
                    c.appendChild(el);
                }
            });
            document.getElementById('empty-state').className = c.children.length === 0 ? 'text-center py-20' : 'hidden';
            lucide.createIcons();
        }

        // --- NEW DRAWER & IMPROVED VOICE LOGIC ---

        function toggleDrawer(isOpen) {
            const d = document.getElementById('exam-drawer');
            const o = document.getElementById('drawer-overlay');
            if (isOpen) {
                d.classList.add('open');
                o.classList.add('open');
            } else {
                d.classList.remove('open');
                o.classList.remove('open');
            }
        }

// --- XỬ LÝ ÂM THANH "NGỌT" (Fixed) ---
        let voices = [];
        let sweetVoice = null;

        // Hàm nạp danh sách giọng
        function loadVoices() {
            voices = window.speechSynthesis.getVoices();
            // Lọc ra giọng Tiếng Việt
            const vnVoices = voices.filter(v => v.lang.includes('vi'));
            
            if (vnVoices.length > 0) {
                // THUẬT TOÁN TÌM GIỌNG NỮ/NGỌT:
                // 1. Ưu tiên số 1: Giọng Google (Thường là chị Google ngọt ngào trên Chrome/Android)
                sweetVoice = vnVoices.find(v => v.name.includes('Google') || v.name.includes('Vietnamese'));
                
                // 2. Ưu tiên số 2: Giọng có chữ "Female", "Nữ", hoặc "HoaiMy" (Windows)
                if (!sweetVoice) {
                    sweetVoice = vnVoices.find(v => v.name.includes('Female') || v.name.includes('HoaiMy') || v.name.includes('Nu'));
                }

                // 3. Nếu vẫn không tìm ra giọng nữ cụ thể, lấy đại giọng Việt đầu tiên nhưng chỉnh Pitch cao lên
                if (!sweetVoice) sweetVoice = vnVoices[0];
                
                console.log("Đã chọn giọng:", sweetVoice.name);
            }
        }

        // Kích hoạt nạp giọng (Chrome cần cái này)
        if ('speechSynthesis' in window) {
            window.speechSynthesis.onvoiceschanged = loadVoices;
            // Gọi thử một lần ngay lập tức phòng khi trình duyệt đã nạp xong
            loadVoices(); 
        }

        function speakPraise(text) {
            if (!('speechSynthesis' in window)) return;
            
            // Nếu chưa có giọng, thử nạp lại
            if (!sweetVoice) loadVoices();

            window.speechSynthesis.cancel(); // Dừng giọng cũ

            const u = new SpeechSynthesisUtterance(text);
            u.lang = 'vi-VN';
            
            if (sweetVoice) {
                u.voice = sweetVoice;
                
                // TINH CHỈNH TÔNG GIỌNG (QUAN TRỌNG):
                // Nếu là giọng Google (vốn đã là nữ): Để tự nhiên hoặc tăng nhẹ.
                if (sweetVoice.name.includes('Google')) {
                    u.pitch = 0.1; // Hơi cao nhẹ cho vui tai
                    u.rate = 0.1;  // Nói nhanh nhẹn
                } 
                // Nếu không phải Google (nghi ngờ là giọng Nam mặc định của Windows/iOS):
                else {
                    u.pitch = 0.1; // Tăng cao hẳn để giọng Nam nghe mềm hơn (giả giọng nữ)
                    u.rate = 0.1;
                }
            }

            u.volume = 0.6; 
            window.speechSynthesis.speak(u);
        }

        function speakPraise(text) {
            if (!('speechSynthesis' in window)) return;
            
            // Hủy giọng đang nói dở (nếu có) để nói câu mới ngay
            window.speechSynthesis.cancel();

            const u = new SpeechSynthesisUtterance(text);
            u.lang = 'vi-VN'; // Cố định tiếng Việt
            
            // Tìm giọng Google Tiếng Việt hoặc giọng nữ nếu có
            // Trên Android/Chrome thường là "Google Vietnamese"
            if (voices.length === 0) voices = window.speechSynthesis.getVoices();
            const vnVoice = voices.find(v => v.lang.includes('vi') && v.name.includes('Google')) || voices.find(v => v.lang.includes('vi'));
            
            if (vnVoice) u.voice = vnVoice;

            // Tinh chỉnh cho giọng "ngọt" (nữ tính hơn, vui hơn)
            u.pitch = 1.0; // Cao độ: 1 là bình thường, >1 là cao hơn (giống giọng nữ/trẻ em)
            u.rate = 1.0;  // Tốc độ: Hơi nhanh một chút để tạo cảm giác hào hứng
            u.volume = 1.0; // Âm lượng tối đa

            window.speechSynthesis.speak(u);
        }

        // --- UPDATED TAKER LOGIC ---
        function renderTakeUI() {
            const q = takeState.currentExam.questions[takeState.currentQ];
            const mode = takeState.currentExam.mode;
            document.getElementById('take-q-num').innerText = takeState.currentQ + 1;
            document.getElementById('take-q-text').innerHTML = q.text.replace(/\n/g, '<br>');
            document.getElementById('practice-badge').className = mode === 'practice' ? 'ml-2 text-[10px] font-black bg-amber-100 text-amber-800 px-2 py-1 rounded-md uppercase tracking-wide' : 'hidden';
            document.getElementById('take-progress').style.width = `${(Object.keys(takeState.answers).length / takeState.currentExam.questions.length) * 100}%`;
            document.getElementById('palette-info').innerText = `${Object.keys(takeState.answers).length}/${takeState.currentExam.questions.length}`;

            // Buttons
            const btnCheck = document.getElementById('btn-check-practice');
            const btnNext = document.getElementById('btn-next-q');
            if(mode === 'practice') {
                btnCheck.classList.remove('hidden'); btnNext.style.display = 'none';
                document.getElementById('practice-feedback').className='hidden';
                if (takeState.practiceLog[takeState.currentQ]?.isCorrect) { btnCheck.classList.add('hidden'); btnNext.style.display = 'flex'; btnNext.disabled=false; }
            } else {
                btnCheck.classList.add('hidden'); btnNext.style.display = 'flex'; btnNext.disabled=false;
            }

            // Options Render
            const c = document.getElementById('take-options'); c.innerHTML = '';
            if (q.type === 'tf') {
                let h = `<div class="rounded-2xl border border-slate-200 overflow-hidden text-sm shadow-sm"><div class="grid grid-cols-12 bg-slate-50/80 p-4 font-black text-slate-400 uppercase text-xs tracking-wider border-b"><div class="col-span-8 pl-2">Nội dung</div><div class="col-span-2 text-center text-emerald-600">Đúng</div><div class="col-span-2 text-center text-rose-600">Sai</div></div>`;
                q.items.forEach((it, i) => {
                    const ans = takeState.answers[takeState.currentQ]?.[i];
                    h += `<div class="grid grid-cols-12 border-b last:border-0 p-4 items-center hover:bg-white transition bg-white/50"><div class="col-span-8 font-semibold text-slate-700 text-content text-base leading-relaxed pr-2"><b>${String.fromCharCode(97+i)})</b> ${it.text}</div><div class="col-span-2 text-center flex justify-center"><input type="radio" name="tq_${i}" ${ans===true?'checked':''} onclick="saveAns(${i},true)" class="tf-radio w-5 h-5 accent-emerald-500 hover:scale-110 transition cursor-pointer"></div><div class="col-span-2 text-center flex justify-center"><input type="radio" name="tq_${i}" ${ans===false?'checked':''} onclick="saveAns(${i},false)" class="tf-radio w-5 h-5 accent-rose-500 hover:scale-110 transition cursor-pointer"></div></div>`;
                });
                c.innerHTML = h + '</div>';
            } else {
                q.options.forEach((o, i) => {
                    const sel = takeState.answers[takeState.currentQ] === i;
                    const isWrong = mode === 'practice' && takeState.practiceLog[takeState.currentQ]?.lastWrong === i;
                    const isCorrect = mode === 'practice' && takeState.practiceLog[takeState.currentQ]?.isCorrect && q.correct === i;
                    let cls = `p-5 rounded-2xl border-2 cursor-pointer flex items-start transition mb-3 group relative overflow-hidden shadow-sm `;
                    if (isCorrect) cls += `opt-correct`; else if (isWrong) cls += `shake-element opt-wrong`; else if (sel) cls += `border-primary bg-indigo-50 ring-1 ring-primary`; else cls += `border-slate-100 bg-white hover:border-indigo-200 hover:shadow-md hover:-translate-y-0.5`;
                    
                    c.innerHTML += `<div id="opt-${i}" class="${cls}" onclick="if('${mode}'!=='practice'||!document.getElementById('btn-next-q').style.display.includes('flex')){takeState.answers[takeState.currentQ]=${i};renderTakeUI()}"><span class="font-black mr-4 w-8 h-8 rounded-lg border-2 flex-shrink-0 flex items-center justify-center text-sm transition ${sel||isCorrect?'bg-primary border-primary text-white':'bg-slate-50 border-slate-200 text-slate-400 group-hover:border-primary group-hover:text-primary'}">${String.fromCharCode(65+i)}</span><span class="text-slate-700 font-medium text-base leading-relaxed text-content pt-0.5">${o}</span></div>`;
                });
            }
            // Palette (In Drawer)
            const p=document.getElementById('palette-grid'); p.innerHTML='';
            takeState.currentExam.questions.forEach((_,i)=>{ p.innerHTML+=`<button class="h-10 w-10 rounded-xl text-xs font-black transition shadow-sm ${takeState.currentQ===i?'ring-2 ring-offset-2 ring-primary bg-primary text-white scale-110':(takeState.answers[i]!==undefined?'bg-indigo-100 text-indigo-700':'bg-white border border-slate-200 text-slate-400 hover:border-primary hover:text-primary')}" onclick="takeState.currentQ=${i};renderTakeUI();toggleDrawer(false)">${i+1}</button>`; });
        }
        
        function saveAns(i,v){ if(!takeState.answers[takeState.currentQ]) takeState.answers[takeState.currentQ]={}; takeState.answers[takeState.currentQ][i]=v; }
        
   // --- KHO ÂM THANH ANIME (ULTIMATE EDITION) ---
        const animeAudioCache = {
            // 2-4: Khởi động
            streak2: new Audio("./yatta.mp3"),
            streak3: new Audio("https://www.myinstants.com/media/sounds/anime-wow-sound-effect.mp3"),
            streak4: new Audio("./sugoi.mp3"),
            
            // 5-9: Ara Ara (Giữ nguyên)
            streak5: new Audio("https://www.myinstants.com/media/sounds/ara-ara.mp3"), 
            
            // 10+: Tuturu (Steins;Gate) - Cực dễ thương
            streak10: new Audio("https://www.myinstants.com/media/sounds/tuturu_1.mp3"),

            // 20+: Nico Nico Nii (Love Live) - Huyền thoại
           streak20: new Audio("https://www.myinstants.com/media/sounds/ayaya.mp3"),
            // 30+: Moe Moe Kyun (Maid Cafe) - Siêu cấp
            streak30: new Audio("https://www.myinstants.com/media/sounds/moe-moe-kyun.mp3"),

            // 40+: O Kawaii Koto (Kaguya-sama) - Trùm cuối-
           streak40: new Audio("./oniisama.mp3"),

            // Sai: Baka!
           wrong: new Audio("./baka.mp3")
       }
        // Nạp trước (Preload)
        for (let key in animeAudioCache) {
            animeAudioCache[key].load();
            animeAudioCache[key].volume = 1.0; 
        }

       function playAnimeVoice(streak) {
            // Dừng nhạc cũ
            for (let key in animeAudioCache) {
                animeAudioCache[key].pause();
                animeAudioCache[key].currentTime = 0;
            }

            let audioToPlay = null;

            // LOGIC KIỂM TRA MỐC (Check từ to xuống bé)
            if (streak >= 40) audioToPlay = animeAudioCache.streak40;      // Mốc 40
            else if (streak >= 30) audioToPlay = animeAudioCache.streak30; // Mốc 30
            else if (streak >= 20) audioToPlay = animeAudioCache.streak20; // Mốc 20
            else if (streak >= 10) audioToPlay = animeAudioCache.streak10; // Mốc 10
            else if (streak >= 5) audioToPlay = animeAudioCache.streak5;   // Mốc 5
            else if (streak === 4) audioToPlay = animeAudioCache.streak4;
            else if (streak === 3) audioToPlay = animeAudioCache.streak3;
            else if (streak === 2) audioToPlay = animeAudioCache.streak2;
            else if (streak === 0) audioToPlay = animeAudioCache.wrong;    // Sai

            if (audioToPlay) {
                const playPromise = audioToPlay.play();
                if (playPromise !== undefined) {
                    playPromise.catch(error => {
                        console.log("Lỗi file audio:", error);
                        fallbackToTTS(streak); // Gọi dự phòng nếu lỗi
                    });
                }
            }
        }

        function fallbackToTTS(streak) {
            if (!('speechSynthesis' in window)) return;
            window.speechSynthesis.cancel(); 

            let text = "";
            // Text dự phòng cho chị Google đọc
            if (streak >= 40) text = "O Kawaii Koto!";
            else if (streak >= 30) text = "Moe Moe Kyun!";
            else if (streak >= 20) text = "Ayaya!";
            else if (streak >= 10) text = "Tuturu!";
            else if (streak >= 5) text = "Sasuga!"; 
            else if (streak === 4) text = "Sugoi!";
            else if (streak === 3) text = "Wow!"; 
            else if (streak === 2) text = "Yatta!";
            else if (streak === 0) text = "Onii-chan Baka!"; 

            if (!text) return;
            const u = new SpeechSynthesisUtterance(text);
            u.lang = 'ja-JP'; 
            // ... (Giữ nguyên đoạn tìm giọng ở code cũ) ...
            const voices = window.speechSynthesis.getVoices();
            const jpVoice = voices.find(v => v.lang.includes('ja'));
            if (jpVoice) u.voice = jpVoice;
            u.pitch = 1.5; u.rate = 1.0; u.volume = 1.0;
            window.speechSynthesis.speak(u);
        }
       // --- HÀM KIỂM TRA ĐÁP ÁN (Đã sửa lỗi mất tiếng khi SAI) ---
        function checkPracticeAnswer() {
            const q = takeState.currentExam.questions[takeState.currentQ];
            const fb = document.getElementById('practice-feedback');
            let ok = false; 
            
            // 1. Kiểm tra Logic Đúng/Sai
            if(q.type==='tf') { 
                const ua=takeState.answers[takeState.currentQ]||{}; 
                ok=q.items.every((it,i)=>ua[i]===it.isTrue); 
            } else { 
                ok=takeState.answers[takeState.currentQ]===q.correct; 
            }

            // Khởi tạo log
            if(!takeState.practiceLog[takeState.currentQ]) {
                takeState.practiceLog[takeState.currentQ]={attempts:0, firstTry:true, isCorrect:false};
            }
            
            if (ok) {
                // === ĐÚNG ===
                if (takeState.practiceLog[takeState.currentQ].firstTry) {
                    takeState.streak = (takeState.streak || 0) + 1;
                }
                takeState.practiceLog[takeState.currentQ].isCorrect = true;
              let praiseText = "Chính xác!";
                let subText = "Bạn đã làm rất tốt.";
                
                // CẤU HÌNH LỜI KHEN THEO CẤP ĐỘ (Level Up!)
                if (takeState.streak >= 40) {
                    praiseText = "HACK GAME À?! (Onii sama)";
                    subText = "Trình độ này vượt qua nhân loại rồi!";
                } else if (takeState.streak >= 30) {
                    praiseText = "VÔ ĐỐI (Moe Moe Kyun)!";
                    subText = "Sức mạnh tình yêu hủy diệt!";
                } else if (takeState.streak >= 20) {
                    praiseText = "HUYỀN THOẠI (Ayaya)!";
                    subText = "Ayaya! Bạn quá nhanh và nguy hiểm!";
                } else if (takeState.streak >= 10) {
                    praiseText = "THẦN THÁNH (Tuturu)!";
                    subText = "Chuỗi 10 câu! Bạn quá đẳng cấp!";
                } else if (takeState.streak >= 5) {
                    praiseText = "THIÊN TÀI (Ara Ara)!";
                    subText = "Không ai nói cho bạn biết bạn là thiên tài sao?";
                } else if (takeState.streak === 4) {
                    praiseText = "TUYỆT ĐỈNH (Sugoi)!";
                    subText = "Phong độ của bạn đang rất cao!";
                } else if (takeState.streak === 3) {
                    praiseText = "ĐỈNH CAO (Wow)!";
                    subText = "3 câu liên tiếp rồi!";
                } else if (takeState.streak === 2) {
                    praiseText = "HAY QUÁ (Yatta)!";
                    subText = "Khởi đầu thuận lợi!";
                }

                fb.className = 'mt-6 p-5 rounded-2xl bg-emerald-50 border border-emerald-200 text-emerald-700 flex items-center gap-4 animate-slide-in-right shadow-sm';
                fb.innerHTML = `<div class="w-12 h-12 bg-emerald-100 rounded-full flex-shrink-0 flex items-center justify-center"><i data-lucide="check" width="24"></i></div> <div><p class="font-black text-xl">${praiseText}</p><p class="text-sm opacity-90 font-medium">${subText}</p></div>`;
                
                // Âm thanh đúng
                if (takeState.practiceLog[takeState.currentQ].firstTry) {
                    playAnimeVoice(takeState.streak);
                }

                document.getElementById('btn-check-practice').classList.add('hidden'); 
                document.getElementById('btn-next-q').style.display = 'flex'; 
                
            } else {
                takeState.streak = 0;
                takeState.practiceLog[takeState.currentQ].attempts++; 
                takeState.practiceLog[takeState.currentQ].firstTry = false;
                playAnimeVoice(0); 
                fb.className = 'mt-6 p-5 rounded-2xl bg-rose-50 border border-rose-200 text-rose-700 flex items-center gap-4 animate-shake shadow-sm';
                fb.innerHTML = '<div class="w-12 h-12 bg-rose-100 rounded-full flex-shrink-0 flex items-center justify-center"><i data-lucide="x" width="24"></i></div> <div><p class="font-black text-xl">Chưa đúng</p><p class="text-sm opacity-90 font-medium">Đừng lo, hãy thử suy nghĩ lại nhé.</p></div>';
                if(q.type==='mc') { 
                    takeState.practiceLog[takeState.currentQ].lastWrong = takeState.answers[takeState.currentQ]; 
                }
            }
            saveCurrentProgress();
            renderTakeUI();
            fb.classList.remove('hidden'); 
            lucide.createIcons();
        }
       function startExam(id) { 
            const l = document.getElementById('global-loader'); 
            l.classList.remove('hidden'); 
            
            db.collection('exams').doc(id).get().then(doc => { 
                const d = doc.data(); 
                const examId = doc.id;
                
                // Kiểm tra xem có bài lưu không
                const key = `eztest_prog_${currentUser.uid}_${examId}`;
                const savedDataJSON = localStorage.getItem(key);
                
                let isResuming = false;
                let savedData = null;

                if (savedDataJSON) {
                    // Có bài làm dở -> Hỏi người dùng
                    if (confirm("Hệ thống phát hiện bạn đang làm dở đề thi này. Bạn có muốn TIẾP TỤC làm bài không?\n\n(Nhấn OK để làm tiếp, Cancel để làm lại từ đầu)")) {
                        isResuming = true;
                        savedData = JSON.parse(savedDataJSON);
                    } else {
                        // Xóa bài cũ
                        localStorage.removeItem(key);
                    }
                }

                if (isResuming && savedData) {
                    // === KHÔI PHỤC DỮ LIỆU CŨ ===
                    takeState = {
                        currentExam: { id: examId, ...d },
                        currentQ: savedData.currentQ || 0,
                        answers: savedData.answers || {},
                        timeLeft: savedData.timeLeft || (d.duration * 60),
                        startTime: Date.now(), // Reset start time phiên này (logic tính duration tổng sẽ tương đối)
                        practiceLog: savedData.practiceLog || {},
                        streak: savedData.streak || 0
                    };
                } else {
                    // === TẠO BÀI MỚI ===
                    takeState = {
                        currentExam: { id: examId, ...d },
                        currentQ: 0,
                        answers: {},
                        timeLeft: d.duration * 60,
                        startTime: Date.now(),
                        practiceLog: {},
                        streak: 0
                    };
                }

                navigateTo('take'); 
                renderTakeUI(); 
                
                if (takeState.timerId) clearInterval(takeState.timerId); 
                
                takeState.timerId = setInterval(() => { 
                    takeState.timeLeft--; 
                    
                    // Hiển thị thời gian
                    const m = Math.floor(takeState.timeLeft / 60);
                    const s = (takeState.timeLeft % 60).toString().padStart(2, '0');
                    document.getElementById('timer-display').innerText = `${m}:${s}`;
                    
                    // Cứ mỗi 2 giây tự động lưu 1 lần (để lưu thời gian)
                    if (takeState.timeLeft % 2 === 0) saveCurrentProgress();

                    if (takeState.timeLeft <= 0 && d.mode === 'standard') submitExam(); 
                }, 1000); 

            }).finally(() => l.classList.add('hidden')); 
        }

        // --- Other Standard Functions ---
        function changeQuestion(d){ if(d===1 && takeState.currentExam.mode === 'practice' && !takeState.practiceLog[takeState.currentQ]?.isCorrect) return; const n=takeState.currentQ+d; if(n>=0&&n<takeState.currentExam.questions.length){takeState.currentQ=n;renderTakeUI();saveCurrentProgress();} }
        async function submitExam(){ clearInterval(takeState.timerId); let s=0; const qs=takeState.currentExam.questions; const dur=Math.floor((Date.now()-takeState.startTime)/1000); qs.forEach((q,i)=>{ if(takeState.currentExam.mode==='practice'){ if(takeState.practiceLog[i]?.firstTry) s++; } else { if(q.type==='tf'){ let c=0; q.items.forEach((it,idx)=>{if(takeState.answers[i]?.[idx]===it.isTrue)c++}); s+=(c/4); } else { if(takeState.answers[i]===q.correct)s++; } } }); const f=((s/qs.length)*10).toFixed(2); await db.collection('results').add({examId:takeState.currentExam.id, userId:currentUser.uid, userEmail:currentUser.email, examTitle:takeState.currentExam.title, score:parseFloat(f), answers:takeState.answers, totalQ:qs.length, mode:takeState.currentExam.mode, duration:dur, createdAt:new Date().toISOString()}); clearProgress(takeState.currentExam.id);document.getElementById('res-score').innerText=f; navigateTo('result'); }
        function handleFileUpload(i){const f=i.files[0];if(!f)return;if(f.name.endsWith('.docx')){const r=new FileReader();r.onload=e=>mammoth.extractRawText({arrayBuffer:e.target.result}).then(r=>document.getElementById('import-text').value=r.value);r.readAsArrayBuffer(f);}else{const r=new FileReader();r.onload=e=>document.getElementById('import-text').value=e.target.result;r.readAsText(f);}}
        function toggleAccessList() { const v=document.getElementById('input-status').value; document.getElementById('access-list-container').className = v==='restricted'?'block pt-3 border-t':'hidden pt-3 border-t'; if(v==='restricted') renderAccessCheckboxes(); }
        function renderAccessCheckboxes(sIds = []) { const c = document.getElementById('student-checkbox-list'); c.innerHTML = ''; if(allStudents.length===0) c.innerHTML='<p class="text-xs italic">Không có học sinh</p>'; allStudents.forEach(s => { c.innerHTML += `<div class="flex items-center gap-2 p-1"><input type="checkbox" value="${s.id}" class="acc-check w-4 h-4 rounded border-slate-300 text-primary focus:ring-primary" ${sIds.includes(s.id)?'checked':''}> <span class="truncate">${s.email}</span></div>`; }); }
        function changeQuestionType(i,t) { const q=editorQuestions[i]; if(q.type===t)return; if(t==='tf') editorQuestions[i]={type:'tf',text:q.text,items:[{text:'',isTrue:true},{text:'',isTrue:false},{text:'',isTrue:false},{text:'',isTrue:true}]}; else editorQuestions[i]={type:'mc',text:q.text,options:['','','',''],correct:0}; renderEditorQuestions(); }
        function renderEditorQuestions() { const c=document.getElementById('questions-container'); c.innerHTML=''; editorQuestions.forEach((q,i)=>{ const d=document.createElement('div'); d.className="bg-white p-6 rounded-2xl shadow-sm border border-slate-200 relative group hover:border-indigo-200 transition"; let h=`<div class="flex justify-between items-center mb-4"><div class="flex items-center gap-3"><span class="bg-slate-100 text-slate-500 px-2 py-1 rounded-lg text-xs font-black uppercase tracking-wide">Câu ${i+1}</span><select onchange="changeQuestionType(${i},this.value)" class="bg-white border border-slate-200 text-slate-700 text-xs font-bold rounded-lg px-2 py-1 focus:border-primary outline-none"><option value="mc" ${q.type==='mc'?'selected':''}>Trắc nghiệm</option><option value="tf" ${q.type==='tf'?'selected':''}>Đúng/Sai</option></select></div><button onclick="editorQuestions.splice(${i},1);renderEditorQuestions()" class="text-slate-400 hover:text-red-500 transition p-1"><i data-lucide="trash-2" width="18"></i></button></div><textarea class="w-full p-3 bg-slate-50 border-none rounded-xl text-sm font-medium focus:ring-2 focus:ring-primary/20 outline-none mb-4 transition" rows="2" placeholder="Nội dung câu hỏi..." oninput="editorQuestions[${i}].text=this.value">${q.text}</textarea>`; if(q.type==='tf') { h+=`<div class="grid grid-cols-12 gap-2 mb-2 text-[10px] font-black text-slate-400 uppercase tracking-wider"><div class="col-span-8 px-2">Nội dung ý</div><div class="col-span-2 text-center">Đúng</div><div class="col-span-2 text-center">Sai</div></div><div class="space-y-2">`; q.items.forEach((it,ix)=>{ h+=`<div class="grid grid-cols-12 gap-2 items-center bg-slate-50/50 p-2 rounded-lg"><div class="col-span-8 flex gap-2"><span class="font-black text-slate-300 w-4 text-xs pt-1">${String.fromCharCode(97+ix)}</span><input class="flex-1 bg-transparent border-b border-transparent focus:border-primary outline-none text-sm font-medium" value="${it.text}" placeholder="Nhập ý..." oninput="editorQuestions[${i}].items[${ix}].text=this.value"></div><div class="col-span-2 text-center"><input type="radio" name="tf_${i}_${ix}" class="tf-radio accent-emerald-500" ${it.isTrue?'checked':''} onclick="editorQuestions[${i}].items[${ix}].isTrue=true"></div><div class="col-span-2 text-center"><input type="radio" name="tf_${i}_${ix}" class="tf-radio accent-red-500" ${!it.isTrue?'checked':''} onclick="editorQuestions[${i}].items[${ix}].isTrue=false"></div></div>`; }); h+='</div>'; } else { h+='<div class="grid grid-cols-1 sm:grid-cols-2 gap-3">'; q.options.forEach((o,oi)=>{ h+=`<div class="flex items-center gap-3 p-3 border border-slate-200 rounded-xl ${q.correct==oi?'bg-emerald-50 border-emerald-400 ring-1 ring-emerald-400':''} transition"><input type="radio" name="q${i}" ${q.correct==oi?'checked':''} onclick="editorQuestions[${i}].correct=${oi};renderEditorQuestions()" class="w-5 h-5 accent-emerald-500 cursor-pointer"><input class="flex-1 bg-transparent outline-none text-sm font-medium" value="${o}" placeholder="Đáp án ${String.fromCharCode(65+oi)}" oninput="editorQuestions[${i}].options[${oi}]=this.value"></div>`; }); h+='</div>'; } d.innerHTML=h; c.appendChild(d); }); lucide.createIcons(); }
        function editorAddQuestion(t) { if(t==='tf') editorQuestions.push({type:'tf',text:'',items:[{text:'',isTrue:true},{text:'',isTrue:false},{text:'',isTrue:false},{text:'',isTrue:true}]}); else editorQuestions.push({type:'mc',text:'',options:['','','',''],correct:0}); renderEditorQuestions(); }
        function initCreateExam() { document.getElementById('edit-exam-id').value=""; document.getElementById('input-title').value=""; document.getElementById('input-desc').value=""; document.getElementById('input-mode').value="standard"; document.getElementById('input-status').value="open"; toggleAccessList(); editorQuestions=[{type:'mc',text:'',options:['','','',''],correct:0}]; renderEditorQuestions(); navigateTo('editor'); }
        function editExam(id) { const l=document.getElementById('global-loader'); l.classList.remove('hidden'); db.collection('exams').doc(id).get().then(d => { const v=d.data(); document.getElementById('edit-exam-id').value=id; document.getElementById('input-title').value=v.title; document.getElementById('input-desc').value=v.description; document.getElementById('input-duration').value=v.duration; document.getElementById('input-mode').value=v.mode||'standard'; document.getElementById('input-status').value=v.status||'open'; toggleAccessList(); if(v.status==='restricted') renderAccessCheckboxes(v.allowedUsers||[]); editorQuestions=v.questions||[]; renderEditorQuestions(); navigateTo('editor'); }).finally(()=>l.classList.add('hidden')); }
        async function saveExamToFirestore() { const t = document.getElementById('input-title').value; if(!t) return alert("Nhập tên"); const au=[]; if(document.getElementById('input-status').value==='restricted') document.querySelectorAll('.acc-check:checked').forEach(c=>au.push(c.value)); const dt={title:t, description:document.getElementById('input-desc').value, duration:parseInt(document.getElementById('input-duration').value), mode:document.getElementById('input-mode').value, status:document.getElementById('input-status').value, allowedUsers:au, questions:editorQuestions, updatedAt:new Date().toISOString()}; const id=document.getElementById('edit-exam-id').value; if(id) await db.collection('exams').doc(id).update(dt); else { dt.createdAt=new Date().toISOString(); await db.collection('exams').add(dt); } alert("Lưu xong!"); loadExams(); navigateTo('dashboard'); }
        async function deleteExam(id) { if(confirm("Xóa?")) { await db.collection('exams').doc(id).delete(); loadExams(); } }
        async function showAdminHistory(eid){document.getElementById('history-modal').classList.remove('hidden');const b=document.getElementById('history-table-body');b.innerHTML='<tr><td colspan="4" class="p-8 text-center">Loading...</td></tr>';const s=await db.collection('results').where('examId','==',eid).get();if(s.empty){b.innerHTML='<tr><td colspan="4" class="p-8 text-center text-slate-400">Empty</td></tr>';return;}const us={};s.forEach(d=>{const r=d.data();if(!us[r.userId])us[r.userId]={e:r.userEmail,c:0,max:0,h:[]};us[r.userId].c++;if(r.score>us[r.userId].max)us[r.userId].max=r.score;us[r.userId].h.push(r);});b.innerHTML='';Object.values(us).forEach(u=>{b.innerHTML+=`<tr class="border-b hover:bg-slate-50"><td class="p-4 font-bold text-slate-700">${u.e}</td><td class="p-4 text-center"><span class="bg-indigo-100 text-indigo-700 px-2 py-1 rounded font-bold">${u.c}</span></td><td class="p-4 text-center font-black text-emerald-600">${u.max}</td><td class="p-4 text-right text-xs text-slate-400">${new Date(u.h[u.h.length-1].createdAt).toLocaleDateString('vi-VN')}</td></tr>`;});}
        async function loadUsersForAdmin(){navigateTo('users');const t=document.getElementById('user-table-body');t.innerHTML='<tr><td colspan="3" class="p-4 text-center">...</td></tr>';const s=await db.collection('users').get();t.innerHTML='';s.forEach(d=>{const u=d.data();t.innerHTML+=`<tr class="border-b hover:bg-slate-50"><td class="p-4 font-medium">${u.email}</td><td class="p-4"><span class="text-xs font-bold px-2 py-1 rounded ${u.role==='admin'?'bg-purple-100 text-purple-700':'bg-slate-100 text-slate-600'}">${u.role.toUpperCase()}</span></td><td class="p-4 text-right"><button onclick="toggleUserRole('${d.id}','${u.role}')" class="text-xs border px-2 py-1 rounded hover:bg-white shadow-sm">Đổi quyền</button></td></tr>`;});}
        async function toggleUserRole(id,r){await db.collection('users').doc(id).update({role:r==='admin'?'user':'admin'});loadUsersForAdmin();}
        async function loadStudentHistory() { const l=document.getElementById('global-loader'); l.classList.remove('hidden'); navigateTo('student-history'); const b=document.getElementById('student-history-body'); b.innerHTML=''; try{ const s=await db.collection('results').where('userId','==',currentUser.uid).get(); const docs=s.docs.map(d=>({id:d.id,...d.data()})).sort((a,b)=>new Date(b.createdAt)-new Date(a.createdAt)); docs.forEach(r=>{ b.innerHTML+=`<tr class="hover:bg-slate-50 border-b last:border-0 transition"><td class="p-4 font-bold text-slate-800">${r.examTitle||'--'}</td><td class="p-4 text-center"><span class="font-black ${r.score>=5?'text-emerald-600':'text-rose-500'} bg-slate-100 px-2 py-1 rounded">${r.score}</span></td><td class="p-4 text-center text-xs uppercase font-bold text-slate-400">${r.mode==='practice'?'Luyện tập':'Thi chuẩn'}</td><td class="p-4 text-right text-slate-500 text-xs">${new Date(r.createdAt).toLocaleDateString('vi-VN')}</td><td class="p-4 text-right"><button onclick='reviewResult(${JSON.stringify({id:r.id,...r})})' class="text-xs bg-white border hover:border-primary hover:text-primary px-3 py-1.5 rounded-lg font-bold shadow-sm">Xem</button></td></tr>`; }); }catch(e){} finally{l.classList.add('hidden');} }
        async function reviewResult(r){ const l=document.getElementById('global-loader'); l.classList.remove('hidden'); try{ const ed=await db.collection('exams').doc(r.examId).get(); if(!ed.exists) return alert("Đề gốc đã xóa"); const ex=ed.data(); const ua=r.answers||{}; document.getElementById('review-score').innerText=r.score; const c=document.getElementById('review-questions-container'); c.innerHTML=''; ex.questions.forEach((q,i)=>{ const el=document.createElement('div'); el.className="bg-white p-6 rounded-2xl border border-slate-100 shadow-sm"; let ct=`<div class="mb-4 font-bold text-slate-700 text-lg">Câu ${i+1}: ${q.text}</div>`; if(q.type==='mc'){ const uC=ua[i],cor=q.correct; q.options.forEach((o,oi)=>{ let st="border-slate-200 text-slate-500"; if(oi===cor)st="opt-correct bg-emerald-50 border-emerald-400"; if(oi===uC && uC!==cor)st="opt-wrong bg-rose-50 border-rose-400"; ct+=`<div class="p-3 rounded-xl border ${st} mb-2 font-medium text-sm flex gap-3 items-center"><span class="w-6 h-6 flex items-center justify-center rounded-full bg-white border text-xs font-bold shadow-sm">${String.fromCharCode(65+oi)}</span>${o}</div>`; }); } else { ct+=`<div class="grid grid-cols-3 bg-slate-100 p-2 rounded-t-lg text-xs font-black uppercase text-slate-400"><div class="col-span-1">Ý</div><div class="text-center">Chọn</div><div class="text-center">Đáp án</div></div>`; q.items.forEach((it,ix)=>{ const u=ua[i]?.[ix]; const isR=u===it.isTrue; ct+=`<div class="grid grid-cols-3 p-3 border-b last:border-0 border-slate-100 text-sm font-medium ${isR?'bg-emerald-50/30':'bg-rose-50/30'}"><div class="col-span-1">${it.text}</div><div class="text-center ${isR?'text-emerald-600':'text-rose-500'} font-bold">${u===undefined?'--':(u?'Đ':'S')}</div><div class="text-center text-blue-600 font-bold">${it.isTrue?'Đ':'S'}</div></div>`; }); } el.innerHTML=ct; c.appendChild(el); }); navigateTo('review-detail'); }catch(e){}finally{l.classList.add('hidden');} }
        async function showLeaderboard(eid, title) { navigateTo('leaderboard'); document.getElementById('lb-exam-title').innerText = title; const tbody = document.getElementById('leaderboard-body'); tbody.innerHTML = '<tr><td colspan="4" class="p-8 text-center text-slate-400">Đang tính toán...</td></tr>'; const s = await db.collection('results').where('examId', '==', eid).get(); if(s.empty) { tbody.innerHTML = '<tr><td colspan="4" class="p-8 text-center italic">Chưa có dữ liệu.</td></tr>'; return; } const userBest = {}; s.forEach(doc => { const r = doc.data(); if (!userBest[r.userId]) { userBest[r.userId] = r; } else { const cb = userBest[r.userId]; if (r.score > cb.score) userBest[r.userId] = r; else if (r.score === cb.score) { if ((r.duration||9999) < (cb.duration||9999)) userBest[r.userId] = r; } } }); let ranking = Object.values(userBest).sort((a, b) => { if (b.score !== a.score) return b.score - a.score; return (a.duration || 0) - (b.duration || 0); }); tbody.innerHTML = ''; ranking.forEach((r, idx) => { const rank = idx + 1; let badge = `<span class="font-black text-slate-400 text-lg">#${rank}</span>`; if(rank===1) badge=`<div class="rank-1 w-8 h-8 rounded-full flex items-center justify-center font-bold mx-auto shadow-md">1</div>`; if(rank===2) badge=`<div class="rank-2 w-8 h-8 rounded-full flex items-center justify-center font-bold mx-auto shadow-sm">2</div>`; if(rank===3) badge=`<div class="rank-3 w-8 h-8 rounded-full flex items-center justify-center font-bold mx-auto shadow-sm">3</div>`; const durText = r.duration ? `${Math.floor(r.duration/60)}p${r.duration%60}s` : '--'; tbody.innerHTML += `<tr class="border-b border-slate-50 hover:bg-white transition"><td class="p-4 text-center">${badge}</td><td class="p-4 font-bold text-slate-700">${r.userEmail.split('@')[0]}</td><td class="p-4 text-center"><span class="bg-indigo-50 text-primary px-3 py-1 rounded-lg font-black">${r.score}</span></td><td class="p-4 text-right text-xs font-mono text-slate-500">${durText}</td></tr>`; }); }
        
        // Import Processing Logic from previous request
        function processImport() {
            const text = document.getElementById('import-text').value;
            if (!text.trim()) return alert("Vui lòng nhập nội dung");
            let contentBody = text;
            const rawBlocks = text.split(/(?:\n|^)(?=Câu\s+\d+[:.])/i).filter(b => b.trim());
            const newQuestions = [];
            rawBlocks.forEach(block => {
                const firstOptMatch = block.match(/(?:\n|^|\s)(\*?)\s*([A-D]|[a-d])(?:\.|(?:\)))\s+/);
                if (!firstOptMatch) return;
                const questionText = block.substring(0, firstOptMatch.index).replace(/^Câu\s+\d+[:.]\s*/i, '').trim();
                let optionsPart = block.substring(firstOptMatch.index);
                const bottomKeys = {};
                const keyRegex = /([a-d])\s*[\)\-]\s*([ĐSds])/g;
                let km;
                while ((km = keyRegex.exec(optionsPart)) !== null) {
                    bottomKeys[km[1].toLowerCase()] = (km[2].toLowerCase() === 'đ' || km[2].toLowerCase() === 'd');
                }
                const isTF = (optionsPart.match(/[a-d]\)/g) || []).length > (optionsPart.match(/[A-D][.]/g) || []).length;
                if (isTF) {
                    const items = [];
                    const regexItem = /(?:^|\s)(\*?)\s*([a-d])\)\s+([\s\S]*?)(?=(?:\n\s*\*?\s*[a-d]\))|$)/g;
                    let match;
                    const tempMap = {};
                    while ((match = regexItem.exec(optionsPart)) !== null) {
                        const label = match[2].toLowerCase();
                        let isTrue = match[1] === '*';
                        let content = match[3].trim();
                        if(content.match(/[\(–-]\s*[ĐD](?:úng)?\)?$/i)) { isTrue = true; content = content.replace(/[\(–-]\s*[ĐD](?:úng)?\)?$/i, '').trim(); }
                        if(content.match(/[\(–-]\s*[S](?:ai)?\)?$/i)) { isTrue = false; content = content.replace(/[\(–-]\s*[S](?:ai)?\)?$/i, '').trim(); }
                        if(bottomKeys[label] !== undefined) isTrue = bottomKeys[label];
                        tempMap[label] = { text: content, isTrue };
                    }
                    ['a','b','c','d'].forEach(l => items.push(tempMap[l] || {text:"...", isTrue:false}));
                    newQuestions.push({ type: 'tf', text: questionText, items: items });
                } else {
                    const opts = ["","","",""]; let corr = 0;
                    const regexMC = /(?:^|\s)(\*?)\s*([A-D])\.\s+([\s\S]*?)(?=(?:\n\s*\*?\s*[A-D]\.)|$)/g;
                    let match;
                    while ((match = regexMC.exec(optionsPart)) !== null) {
                        const idx = match[2].toUpperCase().charCodeAt(0) - 65;
                        let isC = match[1] === '*';
                        let content = match[3].trim();
                        if(content.match(/\(Đúng\)$/i)) { isC = true; content = content.replace(/\(Đúng\)$/i, '').trim(); }
                        if(idx>=0 && idx<=3) { opts[idx] = content; if(isC) corr = idx; }
                    }
                    newQuestions.push({ type: 'mc', text: questionText, options: opts, correct: corr });
                }
            });
            if (newQuestions.length) {
                editorQuestions = [...editorQuestions, ...newQuestions];
                renderEditorQuestions();
                document.getElementById('import-modal').classList.add('hidden');
                document.getElementById('import-text').value = '';
                alert(`Nhập thành công ${newQuestions.length} câu!`);
            } else {
                alert("Không tìm thấy câu hỏi. Kiểm tra định dạng 'Câu X: ...'");
            }
        }
    </script>
</body>
</html>